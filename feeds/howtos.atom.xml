<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom"><title>Mark's notes - HOWTOs</title><link href="/" rel="alternate"></link><link href="/feeds/howtos.atom.xml" rel="self"></link><id>/</id><updated>2021-06-24T14:00:00+01:00</updated><entry><title>Helpful GTK4 Development tips</title><link href="/helpful-gtk4-development-tips.html" rel="alternate"></link><published>2021-06-24T14:00:00+01:00</published><updated>2021-06-24T14:00:00+01:00</updated><author><name>Mark</name></author><id>tag:None,2021-06-24:/helpful-gtk4-development-tips.html</id><summary type="html"></summary><content type="html">&lt;p&gt;Show me all the icons I have installed in my platform pak:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;flatpak-builder --run --socket=session-bus ./build com.verynoisy.najork.json /usr/bin/gtk4-icon-browser
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Not many, huh? Use the systme ones:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;env=XDG_DATA_DIRS=/run/host/share:/app/share:/usr/share:/usr/share/runtime/share
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;</content><category term="HOWTOs"></category><category term="GTK"></category><category term="Flatpak"></category><category term="icons"></category></entry><entry><title>How to build an only-slightly-less-than-trivial GTK4 app using Flatpak</title><link href="/how-to-build-an-only-slightly-less-than-trivial-gtk4-app-using-flatpak.html" rel="alternate"></link><published>2021-06-18T21:30:00+01:00</published><updated>2021-06-18T21:30:00+01:00</updated><author><name>Mark</name></author><id>tag:None,2021-06-18:/how-to-build-an-only-slightly-less-than-trivial-gtk4-app-using-flatpak.html</id><summary type="html">&lt;p&gt;GTK4 is pretty new, and so it's likely that if you want to target it, you'll need to get your head around Flatpak in order to distribute your work. Here, I've taken the GTK4 'custom drawing' example from the GTK docs and wrapped it in a meson and Flatpak example, with a bit of explanation.&lt;/p&gt;</summary><content type="html">&lt;p&gt;GTK4 is pretty new, and so it's likely that if you want to target it, you'll need to get your head around Flatpak in order to distribute your work.&lt;/p&gt;
&lt;p&gt;Herein is the &lt;a href="https://developer.gnome.org/gtk4/stable/ch01s04.html"&gt;GTK4 'custom drawing' example from the docs&lt;/a&gt; wrapped in a meson and Flatpak example.&lt;/p&gt;
&lt;p&gt;&lt;i&gt;(Note, this write up doesn't cover publishing your application... yet)&lt;/i&gt;&lt;/p&gt;
&lt;dl&gt;
  &lt;dt&gt;App name:&lt;/dt&gt;
    &lt;dd&gt;drawing-example
  &lt;dt&gt;App domain:&lt;/dt&gt;
    &lt;dd&gt;com.verynoisy &lt;i&gt;This is my domain, make up your own!&lt;/i&gt;
  &lt;dt&gt;Build system:&lt;/dt&gt;
    &lt;dd&gt;meson + ninja (c.f. configure + make)
&lt;/dl&gt;

&lt;p&gt;Dir structure:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;drawing-example/
  source/
    meson.build
    src/
      meson.build
      drawing-example.c
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Grab the source from the gtk4 docs: https://developer.gnome.org/gtk4/stable/ch01s04.html&lt;/p&gt;
&lt;p&gt;Place in &lt;code&gt;drawing-example/source/src/drawing-example.c&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;Edit the source so the app name is &lt;code&gt;com.verynoisy.drawing-example&lt;/code&gt; on line 182 - this is important to ensure DBus permissions are correct, since Flatpak by default will only grant portal permissions to the bus of the same name as the app.&lt;/p&gt;
&lt;p&gt;Install latest flatpak:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;sudo add-apt-repository ppa:alexlarsson/flatpak
sudo apt update
sudo apt install flatpak flatpak-builder
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Install latest platform and sdk images:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;flatpak install org.gnome.Sdk//master
flatpak install org.gnome.Platform//40
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Create top level meson build specification:&lt;/p&gt;
&lt;p&gt;In &lt;code&gt;drawing-example/source/meson.build&lt;/code&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;project(&amp;#39;drawing-example&amp;#39;, &amp;#39;c&amp;#39;,
  meson_version: &amp;#39;&amp;gt;= 0.56.0&amp;#39;,
  default_options: [
    &amp;#39;warning_level=2&amp;#39;,
    &amp;#39;c_std=gnu11&amp;#39;,
  ],
)

subdir(&amp;#39;src&amp;#39;)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;...and one in the actual source directory:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;drawing_example_sources = [
  &amp;#39;drawing-example.c&amp;#39;,
]

drawing_example_deps = [
  dependency(&amp;#39;gtk4&amp;#39;, version: &amp;#39;&amp;gt;= 4.0&amp;#39;),
]

executable(&amp;#39;drawing-example&amp;#39;, drawing_example_sources,
  dependencies: drawing_example_deps, install: true
)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;(This is needlessly fragmented for a simple project, but you'll need this separation the moment your project gets even vaguely complex.)&lt;/p&gt;
&lt;p&gt;Create flatpak manifest so it knows how to invoke your build, etc, in &lt;code&gt;drawing-example/com.verynoisy.drawing-example.yml&lt;/code&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="nn"&gt;---&lt;/span&gt;
&lt;span class="nt"&gt;app-id&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;com.verynoisy.drawing-example&lt;/span&gt;
&lt;span class="nt"&gt;runtime&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;org.gnome.Platform&lt;/span&gt;
&lt;span class="nt"&gt;runtime-version&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;40&amp;#39;&lt;/span&gt;
&lt;span class="nt"&gt;sdk&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;org.gnome.Sdk&lt;/span&gt;
&lt;span class="nt"&gt;command&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;drawing-example&lt;/span&gt;
&lt;span class="nt"&gt;finish-args&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
  &lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;--share=ipc&amp;quot;&lt;/span&gt;
  &lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;--socket=x11&amp;quot;&lt;/span&gt;
  &lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;--share=network&amp;quot;&lt;/span&gt;
  &lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;--device=dri&amp;quot;&lt;/span&gt;  &lt;span class="c1"&gt;# for opengl&lt;/span&gt;
&lt;span class="nt"&gt;modules&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
  &lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;drawing-example&lt;/span&gt;
    &lt;span class="nt"&gt;buildsystem&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;meson&lt;/span&gt;
    &lt;span class="nt"&gt;sources&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
      &lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="nt"&gt;type&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;dir&lt;/span&gt;
        &lt;span class="nt"&gt;path&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;source&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Build:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;flatpak-builder --install &lt;span class="se"&gt;\&lt;/span&gt;
  --user &lt;span class="se"&gt;\&lt;/span&gt;
  build-dir &lt;span class="se"&gt;\&lt;/span&gt;
  com.verynoisy.drawing-example.yml &lt;span class="se"&gt;\&lt;/span&gt;
  com.verynoisy.drawing-example
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;(You can add &lt;code&gt;--force-clean&lt;/code&gt; if you've just made changes to configs)&lt;/p&gt;
&lt;p&gt;This will do this following:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Initialise a flatpak build directory with your chosen platform and SDK, in &lt;code&gt;build-dir&lt;/code&gt;.&lt;/li&gt;
&lt;li&gt;Run &lt;code&gt;meson setup --prefix=/app&lt;/code&gt; against the build config on your host machine, but in the sandbox, using the meson version (and other dev tools) provided by the SDK you selected, outputting all build files somewhere in &lt;code&gt;build-dir&lt;/code&gt; (you don't really need to care where).&lt;/li&gt;
&lt;li&gt;Sandbox-run &lt;code&gt;ninja&lt;/code&gt; (c.f. &lt;code&gt;make&lt;/code&gt;) against those meson build files, producing your binary.&lt;/li&gt;
&lt;li&gt;Install it all the the right place in the flatpak build-dir, as if it were installed on a real system under &lt;code&gt;/app&lt;/code&gt; (c.f. &lt;code&gt;/usr/local/&lt;/code&gt;, etc)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Test:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;flatpak-builder &lt;span class="se"&gt;\&lt;/span&gt;
  --run --socket&lt;span class="o"&gt;=&lt;/span&gt;x11 &lt;span class="se"&gt;\&lt;/span&gt;
  --share&lt;span class="o"&gt;=&lt;/span&gt;ipc &lt;span class="se"&gt;\&lt;/span&gt;
  --device&lt;span class="o"&gt;=&lt;/span&gt;dri &lt;span class="se"&gt;\&lt;/span&gt;
  build-dir &lt;span class="se"&gt;\&lt;/span&gt;
  com.verynoisy.drawing-example.yml &lt;span class="se"&gt;\&lt;/span&gt;
  /app/bin/drawing-example
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h2&gt;debugging DBus probs (e.g. can't register, etc)&lt;/h2&gt;
&lt;p&gt;Listen for all DBus activity&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;dbus-monitor --session
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;See what this app tries to do:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;flatpak-builder --run &lt;span class="se"&gt;\&lt;/span&gt;
  --socket&lt;span class="o"&gt;=&lt;/span&gt;session-bus &lt;span class="se"&gt;\&lt;/span&gt;
  --share&lt;span class="o"&gt;=&lt;/span&gt;network &lt;span class="se"&gt;\&lt;/span&gt;
  --socket&lt;span class="o"&gt;=&lt;/span&gt;x11 &lt;span class="se"&gt;\&lt;/span&gt;
  --share&lt;span class="o"&gt;=&lt;/span&gt;ipc &lt;span class="se"&gt;\&lt;/span&gt;
  --device&lt;span class="o"&gt;=&lt;/span&gt;dri &lt;span class="se"&gt;\&lt;/span&gt;
  build-dir &lt;span class="se"&gt;\&lt;/span&gt;
  com.verynoisy.drawing-example.yml &lt;span class="se"&gt;\&lt;/span&gt;
  /app/bin/drawing-example
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;TODO:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Debugging&lt;/li&gt;
&lt;li&gt;Releasing&lt;/li&gt;
&lt;li&gt;Drawing the rest of the owl...&lt;/li&gt;
&lt;/ul&gt;</content><category term="HOWTOs"></category><category term="GTK"></category><category term="Flatpak"></category><category term="meson"></category></entry></feed>